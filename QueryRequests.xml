<QueryRequests>
    <Query id="1">
        SELECT @@SERVERNAME
    </Query>

    <Query id="2-SA"> select name,type_desc
FROM     master.sys.server_principals 
WHERE    IS_SRVROLEMEMBER ('sysadmin',name) = 1 and is_disabled=0
ORDER BY type_desc
    </Query>

 
    <Query id="3-agent">
        DECLARE
        @InstanceName      NVARCHAR(128),
        @SQLserviceName    NVARCHAR(128),
        @AgentServiceName  NVARCHAR(128),
        @FriendlyAgentName NVARCHAR(128),
        @keyService        NVARCHAR(255),
        @DelayedAutostart  INT;

        -- ── имя инстанса ────────────────────────────────────────────
        SET @InstanceName = CAST(SERVERPROPERTY('INSTANCENAME') AS NVARCHAR(128));

        IF @InstanceName IS NULL
        BEGIN
        SET @AgentServiceName   = N'SQLSERVERAGENT';
        SET @FriendlyAgentName  = N'SQL Server Agent (MSSQLSERVER)';
        END
        ELSE
        BEGIN
        SET @SQLserviceName     = N'$' + @InstanceName;         -- для реестра
        SET @AgentServiceName   = N'SQLAgent' + @SQLserviceName;
        SET @FriendlyAgentName  = N'SQL Server Agent (' + @InstanceName + N')';
        END

        -- ── DelayedAutostart из реестра ─────────────────────────────
        SET @keyService = N'SYSTEM\CurrentControlSet\Services\' + @AgentServiceName;

        EXEC master.sys.xp_regread
        @rootkey    = 'HKEY_LOCAL_MACHINE',
        @key        = @keyService,
        @value_name = 'DelayedAutostart',
        @value      = @DelayedAutostart OUTPUT;

        -- ── статус службы из DMV ────────────────────────────────────
        DECLARE @Status NVARCHAR(60) = (
        SELECT TOP (1) status_desc
        FROM sys.dm_server_services
        WHERE servicename = @FriendlyAgentName
        );

        IF @Status IS NULL SET @Status = N'UNKNOWN';

        -- ── итоговый вывод ──────────────────────────────────────────
        SELECT
        @AgentServiceName           AS AgentServiceName,
        ISNULL(@DelayedAutostart,0) AS DelayedAutostart,
        @Status                     AS Status,
        @@SERVERNAME                AS ServerName;

   </Query>
        </QueryRequests>

